#!/usr/bin/env bash
# Mock for `gh` CLI.
# Behavior is controlled by environment variables:
#   GH_MOCK_ISSUE_STATE    - JSON for `gh issue view <N> --json state,title,closedAt`
#   GH_MOCK_PR_JSON        - JSON for `gh pr list ...`
#   GH_MOCK_PR_CLOSES      - issue number a PR closes (default: 800); empty string â†’ no closing ref
#   GH_MOCK_ISSUE_COMMENTS - output for `gh issue view <N> --comments`
#   GH_MOCK_REPO           - repo nameWithOwner (default: owner/repo)

_DEFAULT_ISSUE_STATE='{"state":"OPEN","title":"Test Issue","closedAt":null}'
_DEFAULT_PR_CLOSES=800
_DEFAULT_REPO="owner/repo"

case "$1 $2" in
    "issue view")
        if [[ "${*}" == *"--json"* ]]; then
            echo "${GH_MOCK_ISSUE_STATE:-$_DEFAULT_ISSUE_STATE}"
        else
            # --comments path
            echo "${GH_MOCK_ISSUE_COMMENTS:-}"
        fi
        ;;
    "repo view")
        echo "${GH_MOCK_REPO:-$_DEFAULT_REPO}"
        ;;
    "api graphql")
        # Build a GraphQL search response from GH_MOCK_PR_JSON.
        # Each PR node includes a closingIssuesReferences block derived from GH_MOCK_PR_CLOSES.
        # Use ${var-default} (not :-) so explicit empty string is honoured.
        _closes="${GH_MOCK_PR_CLOSES-$_DEFAULT_PR_CLOSES}"
        _pr_json="${GH_MOCK_PR_JSON:-[]}"
        if [[ -n "$_closes" ]]; then
            _closing_nodes="[{\"number\":${_closes}}]"
        else
            _closing_nodes="[]"
        fi
        _nodes=$(echo "$_pr_json" | jq -c \
            --argjson refs "{\"nodes\":${_closing_nodes}}" \
            '[.[] | . + {"closingIssuesReferences": $refs}]' \
        2>/dev/null) || _nodes="[]"
        echo "{\"data\":{\"search\":{\"nodes\":${_nodes}}}}"
        ;;
    "pr list")
        echo "${GH_MOCK_PR_JSON:-[]}"
        ;;
    "pr view")
        # Return closing issue references for the PR.
        # When --jq flag is present, extract and return just the issue number(s).
        # Use ${GH_MOCK_PR_CLOSES-$_DEFAULT_PR_CLOSES} (not :-) so explicit empty string is honoured.
        _closes="${GH_MOCK_PR_CLOSES-$_DEFAULT_PR_CLOSES}"
        if [[ -n "$_closes" ]]; then
            _full_json="{\"closingIssuesReferences\":[{\"number\":${_closes}}]}"
        else
            _full_json="{\"closingIssuesReferences\":[]}"
        fi
        if [[ "${*}" == *"--jq"* ]]; then
            # Extract the jq filter from args and apply it
            _jq_filter=""
            _found_jq=0
            for _arg in "$@"; do
                if [[ "$_found_jq" -eq 1 ]]; then
                    _jq_filter="$_arg"
                    break
                fi
                [[ "$_arg" == "--jq" ]] && _found_jq=1
            done
            if [[ -n "$_jq_filter" ]]; then
                echo "$_full_json" | jq -r "$_jq_filter"
            else
                echo "$_full_json"
            fi
        else
            echo "$_full_json"
        fi
        ;;
    *)
        echo "{}"
        ;;
esac
