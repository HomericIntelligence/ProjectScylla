# Docker Compose for local development and testing
#
# This file provides convenient ways to build and test the scylla-runner image
# locally before deployment.
#
# Usage:
#   docker-compose build        # Build the image
#   docker-compose run test     # Run validation tests
#   docker-compose run shell    # Interactive shell

services:
  # Main scylla-runner service
  scylla-runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: scylla-runner:latest
    environment:
      # Required environment variables
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Test configuration (override as needed)
      - TIER=${TIER:-T0}
      - MODEL=${MODEL:-claude-sonnet-4-5-20250929}
      - RUN_NUMBER=${RUN_NUMBER:-1}
      - TEST_ID=${TEST_ID:-local-test}
      - TIMEOUT=${TIMEOUT:-300}
    volumes:
      # Mount local workspace
      - ${WORKSPACE_PATH:-./workspace}:/workspace
    stdin_open: true
    tty: true

  # Test service - validates environment
  test:
    extends:
      service: scylla-runner
    command: ["--validate"]
    profiles:
      - test

  # Interactive shell for debugging
  shell:
    extends:
      service: scylla-runner
    command: ["/bin/bash"]
    profiles:
      - dev

  # Version check service
  version:
    extends:
      service: scylla-runner
    command: ["--version"]
    profiles:
      - test
