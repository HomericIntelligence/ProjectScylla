name: Pre-commit

on:
  pull_request:
  push:
    branches: [main]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.62.2
          environments: lint

      - name: Cache pixi environments
        uses: actions/cache@v4
        with:
          path: |
            .pixi
            ~/.cache/rattler/cache
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.lock') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Run pre-commit
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          # Use lightweight lint environment (skips heavy scientific packages)
          pixi install --environment lint
          pixi --version

          # Run pre-commit on changed files only for PRs; all files for pushes to main
          if [ "$EVENT_NAME" = "push" ]; then
            pixi run --environment lint pre-commit run --all-files --show-diff-on-failure
          else
            pixi run --environment lint pre-commit run --from-ref "origin/$BASE_REF" --to-ref HEAD --show-diff-on-failure
          fi

      - name: Upload pre-commit diff
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pre-commit-diffs
          retention-days: 7
          path: |
            .git/pre-commit-*
